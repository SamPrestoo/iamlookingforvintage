<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vintage Clothing Management</title>
    <style>
        body {
            font-family: 'Workbench', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #8b7355;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .btn {
            background: #8b7355;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .btn:hover {
            background: #6d5a42;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .product-form {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        .image-upload-section {
            border: 2px dashed #8b7355;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .image-preview-item {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .image-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        .image-preview-item.thumbnail {
            border-color: #8b7355;
            border-width: 3px;
        }
        .image-preview-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }
        .image-preview-item .thumbnail-btn {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 10px;
            cursor: pointer;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .download-section {
            background: #d4edda;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üéΩ Vintage Clothing Admin</h1>
                <p>Product Management Dashboard</p>
            </div>
            <a href="#" class="logout-btn" onclick="logout()">üö™ Logout</a>
        </div>

        <div class="instructions">
            <h3>üìã Image Management:</h3>
            <ul>
                <li>Upload up to 10 images per product</li>
                <li>Click "Set as Thumbnail" to choose the main image for shop display</li>
                <li>Images are stored in your browser and included in the download</li>
                <li>Supported formats: JPG, PNG, WebP (max 5MB each)</li>
            </ul>
        </div>

        <div class="controls">
            <button class="btn" onclick="showAddForm()">‚ûï Add New Product</button>
            <button class="btn" onclick="loadProducts()">üîÑ Refresh Products</button>
            <a href="/" class="btn">üè† Back to Website</a>
        </div>

        <div id="addProductForm" class="product-form">
            <h3>Add New Product</h3>
            <form id="productForm">
                <div class="form-group">
                    <label>Product ID:</label>
                    <input type="text" id="productId" required readonly>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="productDescription" rows="3" placeholder="Detailed product description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Price ($):</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="productCategory" required>
                        <option value="">Select Category</option>
                        <option value="clothing">Clothing</option>
                        <option value="accessories">Accessories</option>
                        <option value="collectibles">Collectibles</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Product Images:</label>
                    <div class="image-upload-section">
                        <p>üì∑ Click to upload images or drag & drop (max 10 images)</p>
                        <input type="file" id="imageUpload" multiple accept="image/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('imageUpload').click()" class="btn">Choose Images</button>
                    </div>
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                
                <button type="submit" class="btn">üíæ Save Product</button>
                <button type="button" class="btn" onclick="hideAddForm()">‚ùå Cancel</button>
            </form>
        </div>

        <div class="download-section">
            <h3>üì• Download Updated Data</h3>
            <p>After making changes, download the updated files:</p>
            <button class="btn" onclick="downloadProducts()" id="downloadBtn" disabled>üì• Download Updated products.json</button>
        </div>

        <div id="productsContainer">
            <h3>Current Products</h3>
            <div id="productsList" class="product-grid"></div>
        </div>
    </div>

    <script>
        let products = [];
        let hasChanges = false;
        let currentProductImages = [];
        let thumbnailIndex = 0;

        // Check authentication on page load
        window.addEventListener('load', function() {
            checkAuth();
            loadProducts();
        });

        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated');
            const loginTime = sessionStorage.getItem('adminLoginTime');
            
            // Check if logged in and session is less than 24 hours old
            const now = Date.now();
            const sessionExpiry = 24 * 60 * 60 * 1000; // 24 hours
            
            if (!isAuthenticated || !loginTime || (now - parseInt(loginTime)) > sessionExpiry) {
                window.location.href = 'login.html';
                return;
            }
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminLoginTime');
            window.location.href = 'login.html';
        }

        // Image upload handling
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            handleImageUpload(e.target.files);
        });

        function handleImageUpload(files) {
            if (currentProductImages.length + files.length > 10) {
                alert('Maximum 10 images per product allowed!');
                return;
            }

            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum 5MB per image.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    currentProductImages.push({
                        data: e.target.result,
                        name: file.name,
                        size: file.size
                    });
                    updateImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = currentProductImages.map((img, index) => `
                <div class="image-preview-item ${index === thumbnailIndex ? 'thumbnail' : ''}">
                    <img src="${img.data}" alt="${img.name}">
                    <button class="remove-btn" onclick="removeImage(${index})">√ó</button>
                    <button class="thumbnail-btn" onclick="setThumbnail(${index})">üìå</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            currentProductImages.splice(index, 1);
            if (thumbnailIndex >= currentProductImages.length) {
                thumbnailIndex = Math.max(0, currentProductImages.length - 1);
            }
            updateImagePreview();
        }

        function setThumbnail(index) {
            thumbnailIndex = index;
            updateImagePreview();
        }

        async function loadProducts() {
            try {
                const response = await fetch('/products.json');
                const data = await response.json();
                products = data.products || [];
                displayProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsList').innerHTML = '<p>Error loading products. Make sure products.json exists.</p>';
            }
        }

        function displayProducts() {
            const container = document.getElementById('productsList');
            if (products.length === 0) {
                container.innerHTML = '<p>No products found. Add your first product above!</p>';
                return;
            }

            container.innerHTML = products.map(product => {
                const thumbnailImage = product.images && product.images.length > 0 
                    ? product.images[product.thumbnailIndex || 0].data 
                    : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik04NyA3NEg2NEMlOC42IDc0IDU0IDc4LjYgNTQgODRWMTM2QzU0IDE0MS40IDU4LjYgMTQ2IDY0IDE0Nkg4N0M5Mi40IDE0NiA5NyAxNDEuNCA5NyAxMzZWODRDOTcgNzguNiA5Mi40IDc0IDg3IDc0WiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K';
                
                return `
                    <div class="product-card">
                        <img src="${thumbnailImage}" alt="${product.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik04NyA3NEg2NEMlOC42IDc0IDU0IDc4LjYgNTQgODRWMTM2QzU0IDE0MS40IDU4LjYgMTQ2IDY0IDE0Nkg4N0M5Mi40IDE0NiA5NyAxNDEuNCA5NyAxMzZWODRDOTcgNzguNiA5Mi40IDc0IDg3IDc0WiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K'">
                        <h4>${product.name}</h4>
                        <p><strong>ID:</strong> ${product.id}</p>
                        <p><strong>Price:</strong> $${product.price}</p>
                        <p><strong>Category:</strong> ${product.category}</p>
                        <p><strong>Images:</strong> ${product.images ? product.images.length : 0}/10</p>
                        <p><strong>Description:</strong> ${product.description ? product.description.substring(0, 100) + '...' : 'No description'}</p>
                        <button class="btn" onclick="editProduct('${product.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">üóëÔ∏è Delete</button>
                    </div>
                `;
            }).join('');
        }

        function showAddForm() {
            document.getElementById('addProductForm').style.display = 'block';
            document.getElementById('productForm').reset();
            currentProductImages = [];
            thumbnailIndex = 0;
            updateImagePreview();
            // Generate unique ID
            document.getElementById('productId').value = 'product_' + Date.now();
        }

        function hideAddForm() {
            document.getElementById('addProductForm').style.display = 'none';
            currentProductImages = [];
            thumbnailIndex = 0;
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCategory').value = product.category;
                
                currentProductImages = product.images || [];
                thumbnailIndex = product.thumbnailIndex || 0;
                updateImagePreview();
                
                showAddForm();
            }
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(p => p.id !== id);
                displayProducts();
                markChanges();
            }
        }

        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (currentProductImages.length === 0) {
                alert('Please add at least one product image.');
                return;
            }
            
            const productData = {
                id: document.getElementById('productId').value,
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                images: currentProductImages,
                thumbnailIndex: thumbnailIndex
            };

            // Check if editing existing product
            const existingIndex = products.findIndex(p => p.id === productData.id);
            if (existingIndex !== -1) {
                products[existingIndex] = productData;
            } else {
                products.push(productData);
            }

            displayProducts();
            hideAddForm();
            markChanges();
        });

        function markChanges() {
            hasChanges = true;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('downloadBtn').textContent = 'üì• Download Updated products.json ‚ö°';
        }

        function downloadProducts() {
            const data = {
                products: products
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'products.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            hasChanges = false;
            document.getElementById('downloadBtn').textContent = 'üì• Download Updated products.json';
        }
    </script>
</body>
</html>